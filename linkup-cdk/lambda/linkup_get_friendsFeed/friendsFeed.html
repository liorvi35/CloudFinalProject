<!DOCTYPE html>
<html lang="en">
    <head>
        <title>LinkUp - Friends Feed</title>
        <style>
            .popup-form {
                display: none;
                position: fixed;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                align-items: center;
                justify-content: center;
            }
            .form-container {
                background-color: white;
                padding: 20px;
                border-radius: 5px;
            }

            .profile-picture {
                width: 50px;
                height: 50px;
                border-radius: 50%;
                object-fit: cover;
            }
        </style>
    </head>
    <body>
        <h1>Friends Feed</h1>
        <a id="profileLink">
            <img class="profile-picture" id="profilePic" src="" alt="Profile Picture">
        </a>
        <input type="button" onclick="window.location.href='/prod/globalFeed'" value="Global Feed"/>
        <input type="button" onclick="" value="Summerize!" disabled="" id="emailBtn"/>
        <input type="button" onclick="logOut()" value="Log Out"/>
        <div id="postsFeed"></div>
        <script>
            function logOut() {
                localStorage.clear();
                window.location.href="/prod/index";
            }

            async function formatEpochToUTCString(epochTime) {
                const date = new Date(epochTime * 1000);
                
                // Define options for the Israel Time (UTC+3) formatting
                const options = {
                    timeZone: 'Asia/Tel_Aviv', // Israel Time Zone
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false // Use 24-hour format
                };

                // Format the date in Israel Time
                const formattedDate = date.toLocaleString('en-IL', options);
                
                return formattedDate;
            }


            document.addEventListener("DOMContentLoaded", async () => {
                const accountID = localStorage.getItem("accountID");

                const emailBtn = document.getElementById("emailBtn");
                emailBtn.disabled = true;

                document.getElementById("profilePic").src=localStorage.getItem("profilePicture");
                document.getElementById("profileLink").href=`/prod/profile?accountID=${accountID}`

                document.getElementById("emailBtn").onclick = async () => {
                    const responseSendEmail = await fetch("/prod/friendsFeed", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ accountID })
                    });
                    if(!responseSendEmail.ok) {
                        throw new Error(`${responseSendEmail.status}: ${responseSendEmail.statusText}`);
                    }
                    const dataResponseSendEmail = await responseSendEmail.json();
                    if(dataResponseSendEmail.statusCode !== 200) {
                        throw new Error(`${dataResponseSendEmail.statusCode}: ${dataResponseSendEmail.body}`);
                    }
                    alert("Successfully send Email!");
                };
                
                try {
                    const responseFollowing = await fetch(`/prod/followers?accountID=${accountID}`, {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json"
                        }
                    });

                    if(!responseFollowing.ok) {
                        throw new Error(`${responseFollowing.status}: ${responseFollowing.statusText}`);
                    }

                    const dataResponseFollowing = await responseFollowing.json();

                    const responseGetAllPosts = await fetch("/prod/postDB", {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json"
                        }
                    });

                    if(!responseGetAllPosts.ok) {
                        throw new Error(`${responseGetAllPosts.status}: ${responseGetAllPosts.statusText}`);
                    }

                    const dataGetAllPosts = await responseGetAllPosts.json();



                    if(dataGetAllPosts.length > 0) {
                        const postsFeed = document.getElementById("postsFeed");

                        for(let i = 0; i < dataGetAllPosts.length; ++i) {

                            if(!dataResponseFollowing["following"].includes(dataGetAllPosts[i].accountID)) {
                                continue;
                            }

                            const getProfileByID = await fetch(`/prod/db?accountID=${dataGetAllPosts[i].accountID}`, {
                                method: "GET",
                                headers: {
                                    "Content-Type": "application/json"
                                }
                            });

                            const dataGetProfileByID = await getProfileByID.json();

                            const div = document.createElement("div");
                            const hr = document.createElement("hr");

                            const p_id = document.createElement("p");
                            const aLinkToProfile = document.createElement("a");
                            aLinkToProfile.href = `/prod/profile?accountID=${dataGetAllPosts[i].accountID}`;
                            aLinkToProfile.appendChild(p_id);

                            p_id.innerHTML = dataGetProfileByID["firstName"] + " " + dataGetProfileByID["lastName"];
                            div.appendChild(aLinkToProfile);

                            if(dataGetAllPosts[i].postText) {
                                const p_text = document.createElement("p");
                                p_text.innerHTML = dataGetAllPosts[i].postText;
                                div.appendChild(p_text);
                            }
                            if(dataGetAllPosts[i].postPicture) {
                                const post_image = document.createElement("img");
                                post_image.src = dataGetAllPosts[i].postPicture;
                                post_image.style.width = "30%";
                                post_image.style.height = "30%";
                                div.appendChild(post_image);

                                const p_tags = document.createElement("p");
                                p_tags.innerHTML = dataGetAllPosts[i].pictureTags;
                                div.appendChild(p_tags);
                            }
                            const p_time = document.createElement("p");
                            p_time.innerHTML = await formatEpochToUTCString(dataGetAllPosts[i].postTime);
                            div.appendChild(p_time);

                            const likes = dataGetAllPosts[i].likes.length;

                            let comments = 0;
                            let commentsList = dataGetAllPosts[i].comments;
                            for (let j = 0; j < commentsList.length; ++j) {
                                let commentObject = commentsList[j];
                                for (let uuid in commentObject) {
                                    comments += Object.keys(commentObject[uuid]).length;
                                }
                            }

                            const pLikes = document.createElement("p");
                            pLikes.innerHTML = `${likes} Likes, ${comments} Comments`;

                            const likeBtn = document.createElement("input");
                            likeBtn.type = "button";
                            likeBtn.value = "Like";

                            const like = async () => {
                                const responseSetLike = await fetch("/prod/postDB", {
                                    method: "PUT",
                                    headers: {
                                        "Content-Type": "application/json"
                                    },
                                    body: JSON.stringify({
                                        isLike: true,
                                        postAccountID: dataGetAllPosts[i].accountID,
                                        postTime: dataGetAllPosts[i].postTime,
                                        likerAccountID: accountID
                                    })
                                });
                                if(!responseSetLike.ok) {
                                    throw new Error(`${responseSetLike.status}: ${responseSetLike.statusText}`);
                                }
                                const dataResponseSetLike = await responseSetLike.json();
                                if(dataResponseSetLike.statusCode !== 200) {
                                    throw new Error(`${dataResponseSetLike.statusCode}: ${dataResponseSetLike.body}`);
                                }
                            };

                            const unlike = async () => {
                                const responseSetLike = await fetch("/prod/postDB", {
                                    method: "PUT",
                                    headers: {
                                        "Content-Type": "application/json"
                                    },
                                    body: JSON.stringify({
                                        isLike: false,
                                        postAccountID: dataGetAllPosts[i].accountID,
                                        postTime: dataGetAllPosts[i].postTime,
                                        likerAccountID: accountID
                                    })
                                });
                                if(!responseSetLike.ok) {
                                    throw new Error(`${responseSetLike.status}: ${responseSetLike.statusText}`);
                                }
                                const dataResponseSetLike = await responseSetLike.json();
                                if(dataResponseSetLike.statusCode !== 200) {
                                    throw new Error(`${dataResponseSetLike.statusCode}: ${dataResponseSetLike.body}`);
                                }
                            };

                            const isLiked = dataGetAllPosts[i].likes.includes(accountID);
                            let currentLike = isLiked ? unlike : like;
                            likeBtn.value = isLiked ? "Unlike" : "Like";

                            likeBtn.addEventListener("click", async () => {
                                likeBtn.value = (currentLike === like) ? "Unlike" : "Like";
                                await currentLike();
                                const [oldLikes, , oldComments, , ,] = pLikes.textContent.split(" ");
                                const newLikes = (currentLike === like) ? parseInt(oldLikes) + 1 : parseInt(oldLikes) - 1;
                                pLikes.innerHTML = `${newLikes} Likes, ${oldComments} Comments`;
                                currentLike = (currentLike === like) ? unlike : like;
                            });

                            const commentInput = document.createElement("input");
                            commentInput.type = "text";
                            commentInput.placeholder = "Write Your Comment";

                            const commentBtn = document.createElement("input");
                            commentBtn.type = "button";
                            commentBtn.value = "Comment";
                            commentBtn.onclick = async () => {
                                const commentTime = Math.floor(Date.now() / 1000);
                                const commentText = commentInput.value.trim();

                                if(commentText === "") {
                                    alert("Comment cannot be empty!");
                                    return;
                                }

                                const responseNewComment = await fetch("/prod/postDB", {
                                    method: "PUT",
                                    headers: {
                                        "Content-Type": "application/json"
                                    },
                                    body: JSON.stringify({
                                        postAccountID: dataGetAllPosts[i].accountID,
                                        postTime: dataGetAllPosts[i].postTime,
                                        likerAccountID: accountID,
                                        commentText,
                                        commentTime
                                    })
                                });
                                if(!responseNewComment.ok) {
                                    throw new Error(`${responseNewComment.status}: ${responseNewComment.statusText}`);
                                }
                                const dataResponseNewComment = await responseNewComment.json();
                                if(dataResponseNewComment.statusCode !== 200) {
                                    throw new Error(`${dataResponseNewComment.statusCode}: ${dataResponseNewComment.body}`);
                                }

                                const oldLikes = pLikes.textContent.split(" ")[0];
                                const oldComments = pLikes.textContent.split(" ")[2];
                                pLikes.innerHTML = `${oldLikes} Likes, ${parseInt(oldComments) + 1} Comments`;
                                commentInput.value = "";
                            };

                            div.appendChild(pLikes);
                            div.appendChild(likeBtn);

                            div.appendChild(commentInput);
                            div.appendChild(commentBtn);

                            for(let j = 0; j < 2; ++j) {
                                const showLikesBtn = document.createElement("input");
                                showLikesBtn.type = "button";
                                showLikesBtn.id = (j == 0 ? "openFormButtonLikes" : "openFormButtonComments");
                                showLikesBtn.value = (j == 0 ? "Show Likes" : "Show Comments");

                                const showLikesDiv = document.createElement("div");
                                showLikesDiv.id = (j == 0 ? "popupFormLikes" : "popupFormComments");
                                showLikesDiv.className = "popup-form";

                                const showLikesDivInner = document.createElement("div");
                                showLikesDivInner.className = "form-container";

                                const spanLikes = document.createElement("span");
                                spanLikes.id = (j == 0 ? "closeFormButtonLikes" : "closeFormButtonComments");
                                spanLikes.style.cursor = "pointer";
                                spanLikes.innerHTML = "&times;";

                                const h2Likes = document.createElement("h2");
                                h2Likes.innerHTML = (j == 0 ? "Likes" : "Comments");;

                                const ulLikes = document.createElement("ul");
                                ulLikes.id = (j == 0 ? "LikesList" : "CommentsList");

                                if(j == 0) {
                                    for(let k = 0; k < dataGetAllPosts[i].likes.length; ++k) {
                                        const liLikes = document.createElement("li");

                                        const responseGetName = await fetch(`/prod/db?accountID=${dataGetAllPosts[i].likes[k]}`, {
                                            method: "GET",
                                            headers: {
                                                "Content-Type": "application/json"
                                            }
                                        });
                                        if(!responseGetName.ok) {
                                            throw new Error(`${responseGetName.status}: ${responseGetName.statusText}`);
                                        }
                                        const dataResponseGetName = await responseGetName.json();

                                        liLikes.innerHTML = `${dataResponseGetName.firstName} ${dataResponseGetName.lastName}`;
                                        ulLikes.appendChild(liLikes);
                                    }
                                } else {
                                    const comments = dataGetAllPosts[i].comments;
                                    comments.forEach(commentObject => {
                                        const accountID = Object.keys(commentObject)[0];
                                        const commentDetails = commentObject[accountID];
                                        Object.entries(commentDetails).forEach(async ([timestamp, commentList]) => {
                                            const responseGetName = await fetch(`/prod/db?accountID=${accountID}`, {
                                                method: "GET",
                                                headers: {
                                                    "Content-Type": "application/json"
                                                }
                                            });
                                            if(!responseGetName.ok) {
                                                throw new Error(`${responseGetName.status}: ${responseGetName.statusText}`);
                                            }
                                            const dataResponseGetName = await responseGetName.json();

                                            const li = document.createElement("li");
                                            const div = document.createElement("div");

                                            const accountIDP = document.createElement("p");
                                            accountIDP.textContent = `${dataResponseGetName.firstName} ${dataResponseGetName.lastName}`;

                                            const commentP = document.createElement("p");
                                            commentP.textContent = commentList[0];
                            
                                            let commentColor = commentList[1];
                                            if(commentColor && commentColor.trim() === "Positive") {
                                                commentP.style.color = "#00ff08";
                                            } else if(commentColor && commentColor.trim() === "Negative") {
                                                commentP.style.color = "#ff0000";
                                            } else if(commentColor && commentColor.trim() === "Neutral") {
                                                commentP.style.color = "#ff00dd";
                                            }

                                            const unixTimeP = document.createElement("p");
                                            unixTimeP.textContent = await formatEpochToUTCString(timestamp);
                                            
                                            div.appendChild(accountIDP);
                                            div.appendChild(commentP);
                                            div.appendChild(unixTimeP);
                                            li.appendChild(div);
                                            ulLikes.appendChild(li);
                                        });
                                    });
                                }


                                showLikesBtn.addEventListener("click", () => {
                                    showLikesDiv.style.display = "flex";
                                });
                                spanLikes.addEventListener("click", () => {
                                    showLikesDiv.style.display = "none";
                                });
                                window.addEventListener("click", (event) => {
                                    if (event.target == showLikesDiv) {
                                        showLikesDiv.style.display = "none";
                                    }
                                });

                                showLikesDivInner.appendChild(spanLikes);
                                showLikesDivInner.appendChild(h2Likes);
                                showLikesDivInner.appendChild(ulLikes);

                                showLikesDiv.appendChild(showLikesDivInner);

                                div.appendChild(showLikesBtn);
                                div.appendChild(showLikesDiv);
                            }
                            
                            postsFeed.appendChild(div);
                            postsFeed.appendChild(hr)
                        }                        

                        emailBtn.disabled = false;
                    }
                } catch(error) {
                    console.error(error);
                }
            });
        </script>
    </body>
</html>
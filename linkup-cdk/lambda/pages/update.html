<!DOCTYPE html>
<html lang="en">
    <head>
        <title>LinkUp - Update</title>
    </head>
    <body>
        <h1>Update My Profile</h1>
        <h2>Delete User</h2>
        <form>
            <h3>To confirm deletion, enter 'DELETE' please:</h3>
            <input type="text" id="deleteText" placeholder="DELETE"/>
            <input type="button" id="deleteBtn" value="Delete!"/>
        </form>
        <hr/>
        <h2>Update Profile Picture</h2>
        <form>
            <h3>Upload New Profile Picture:</h3>
            <input type="file" accept=".jpeg, .jpg, .png" id="profilePicture"/>
            <input type="button" id="pictureBtn" value="Update Picture!"/>
        </form>
        <hr/>
        <h2>Update Profile Information</h2>
        <form>
            <h2>First Name:</h2>
            <input type="text" id="firstName" placeholder="Your First Name"/>
            <h2>Last Name:</h2>
            <input type="text" id="lastName" placeholder="Your Last Name"/>
            <h2>Password:</h2>
            <input type="password" id="password" placeholder="Your Password"/>
            <h2>Confirm Password:</h2>
            <input type="password" id="confirmPassword" placeholder="Repeat Your Password"/>
            <h2>Email:</h2>
            <input type="email" id="email" placeholder="Your Email" />
            <h2>Birth Date:</h2>
            <input type="date" id="birthDate" />
            <h2>Gender:</h2>
            <select id="gender" >
                <option value="" disabled selected>Your Gender</option>
                <option value="female">Female</option>
                <option value="male">Male</option>
            </select>
            <input type="button" value="Update!" id="updateBtn"/>
        </form>
        <script>
            async function hashStringToSHA256(inputString) {
                const encoder = new TextEncoder();
                const data = encoder.encode(inputString);
                const hashBuffer = await crypto.subtle.digest("SHA-256", data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
                return hashHex;
            }

            async function arrayBufferToBase64(buffer) {
                let binary = "";
                const bytes = new Uint8Array(buffer);
                const len = bytes.byteLength;
                for (let i = 0; i < len; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return window.btoa(binary);
            }

            document.addEventListener("DOMContentLoaded", async () => {
                const accountID = localStorage.getItem("accountID");
                
                document.getElementById("pictureBtn").addEventListener("click", async () => {
                    const fileInput = document.getElementById("profilePicture");
                    const file = fileInput.files[0];
                    if(!file) {
                        alert("Choose new picture!");
                        return;
                    }

                    const reader = new FileReader();

                    reader.onloadend = async () => {
                        const base64File = await arrayBufferToBase64(reader.result);
                        const format = file.type.split("/")[1];

                        try {
                            const responseUploadPicture = await fetch("/prod/db", {
                                method: "PUT",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify({ accountID, base64File, format })
                            });

                            if(!responseUploadPicture.ok) {
                                throw new Error(`${responseUploadPicture.status}: ${responseUploadPicture.statusText}`);
                            }

                            const dataUploadPicture = await responseUploadPicture.json();

                            if(dataUploadPicture.statusCode === 200) {
                                const dataUploadPictureBody = JSON.parse(dataUploadPicture.body);
                                localStorage.setItem("profilePicture", dataUploadPictureBody["profilePicture"]);
                                window.location.href = "/prod/profile";
                            } else {
                                throw new Error(`${dataUploadPicture.statusCode}: ${dataUploadPicture.body}`);
                            }
                        } catch(error) {
                            console.error(error);
                            alert(error);
                        }
                    };

                    reader.readAsArrayBuffer(file);
                });

                document.getElementById("updateBtn").addEventListener("click", async () => {
                    const firstNameInput = document.getElementById("firstName");
                    const lastNameInput = document.getElementById("lastName");
                    const passwordInput = document.getElementById("password");
                    const confirmPasswordInput = document.getElementById("confirmPassword");
                    const emailInput = document.getElementById("email");
                    const birthDateInput = document.getElementById("birthDate");
                    const genderInput = document.getElementById("gender");

                    let count = 0;
                    let firstName = null, lastName = null, password = null, confirmPassword = null, email = null, birthDate = null, gender = null;
                    let updateData = { accountID };
                    if(firstNameInput.value.trim() !== "") {
                        firstName = firstNameInput.value.trim();
                        updateData["firstName"] = firstName;
                        count++;
                    } 
                    if(lastNameInput.value.trim() !== "") {
                        lastName = lastNameInput.value.trim();
                        updateData["lastName"] = lastName;
                        count++;
                    }
                    if(passwordInput.value.trim() !== "" && confirmPasswordInput.value.trim() !== "") {
                        password = passwordInput.value.trim();
                        confirmPassword = confirmPasswordInput.value.trim();
                        if(password !== confirmPassword) {
                            alert("Passwords not match!");
                            return;
                        }
                        updateData["hashedPassword"] = await hashStringToSHA256(password);
                        count++;
                    }
                    if(emailInput.value.trim() !== "") {
                        email = emailInput.value.trim();
                        updateData["email"] = email;
                        count++;
                    }
                    if(birthDateInput.value.trim() !== "") {
                        birthDate = birthDateInput.value.trim();
                        updateData["birthDate"] = birthDate;
                        count++;
                    }
                    if(genderInput.value.trim() !== "") {
                        gender = genderInput.value.trim();
                        updateData["gender"] = gender;
                        count++;
                    }

                    if(count == 0) {
                        alert("Fill at least one input!");
                        return;
                    }

                    try {
                        const responseUpdateUserData = await fetch("/prod/db", {
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify(updateData)
                        });

                        if(!responseUpdateUserData.ok) {
                            throw new Error(`${responseUpdateUserData.status}: ${responseUpdateUserData.statusText}`);
                        }

                        const dataUpdateUserData = await responseUpdateUserData.json();

                        if(dataUpdateUserData.statusCode === 200) {
                            if(firstName !== null) {
                                localStorage.setItem("firstName", firstName);
                            }
                            if(lastName !== null) {
                                localStorage.setItem("lastName", lastName);
                            }
                            if(email !== null) {
                                localStorage.setItem("email", email);
                            }
                            if(birthDate !== null) {
                                localStorage.setItem("birthDate", birthDate);
                            }
                            if(gender !== null) {
                                localStorage.setItem("gender", gender);
                            }

                            window.location.href = "/prod/profile";
                        } else {
                            throw new Error(`${dataUpdateUserData.statusCode}: ${dataUpdateUserData.body}`);
                        }
                    } catch(error) {
                        console.error(error);
                        alert(error);
                    }
                });

                document.getElementById("deleteBtn").addEventListener("click", async () => {
                    const deleteText = document.getElementById("deleteText").value;
                    if(deleteText === "DELETE") {
                        try {
                            const responseDeleteUser = await fetch("/prod/db", {
                                method: "DELETE",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify({ accountID })
                            });

                            if(!responseDeleteUser.ok) {
                                throw new Error(`${responseDeleteUser.status}: ${responseDeleteUser.statusText}`);
                            }

                            const dataDeleteUser = await responseDeleteUser.json();

                            if(dataDeleteUser.statusCode === 200) {
                                localStorage.removeItem("accountID");
                                localStorage.removeItem("firstName");
                                localStorage.removeItem("lastName");
                                localStorage.removeItem("email");
                                localStorage.removeItem("birthDate");
                                localStorage.removeItem("gender");

                                window.location.href = "/prod/index";
                            } else {
                                throw new Error(`${dataDeleteUser.statusCode}: ${dataDeleteUser.body}`);
                            }
                        } catch(error) {
                            console.error(error);
                            alert(error);
                        }
                    } else {
                        alert("misspelled 'DELETE'!");
                        return;
                    }
                });
            });

        </script>
    </body>
</html>
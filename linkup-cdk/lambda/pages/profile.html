<!DOCTYPE html>
<html lang="en">
    <head>
        <title>LinkUp - Profile</title>
    </head>
    <style>
        .popup-form {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }
        .form-container {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
        }
    </style>
    <body>
        <h1>My Profile!</h1>
        <input type="button" onclick="window.location.href='/prod/update'" value="Update Profile"/>
        <input type="button" onclick="" value="" id="followBtn" style="display: none;"/>
        <h2>Profile Information</h2>
        <div id="profileInfo" style="display: none;"></div>
        <hr/>
        <input type="button" id="openFormButtonFollowers" value="Followers"/>
        <div id="popupFormFollowers" class="popup-form">
            <div class="form-container">
                <span id="closeFormButtonFollowers" style="cursor: pointer;">&times;</span>
                <h2>Followers</h2>
                <ul id="followersList"></ul>
            </div>
        </div>
        <input type="button" id="openFormButtonFollowing" value="Following"/>
        <div id="popupFormFollowing" class="popup-form">
            <div class="form-container">
                <span id="closeFormButtonFollowing" style="cursor: pointer;">&times;</span>
                <h2>Following</h2>
                <ul id="followingList"></ul>
            </div>
        </div>
        <!-- <h2>Followers</h2>
        <ul id="followersList" style="display: none;"></ul> -->
        <!-- <h2>Following</h2>
        <ul id="followingList" style="display: none;"></ul> -->
        <hr/>
        <h2>My Posts</h2>
        <div id="postsFeed" style="display: none;"></div>
        <script>
            async function formatEpochToUTCString(epochTime) {
                const date = new Date(epochTime * 1000);
                                
                const day = String(date.getUTCDate()).padStart(2, '0');
                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                const year = date.getUTCFullYear();
                
                const hours = String(date.getUTCHours()).padStart(2, '0');
                const minutes = String(date.getUTCMinutes()).padStart(2, '0');
                const seconds = String(date.getUTCSeconds()).padStart(2, '0');
                
                return `${day}/${month}/${year}, ${hours}:${minutes}:${seconds}`;
            }

            document.addEventListener("DOMContentLoaded", async () => {
                const queryString = window.location.search;
                const urlParams = new URLSearchParams(queryString);
                const accountID = urlParams.get("accountID");

                const storageAccountID = localStorage.getItem("accountID");


                const openFormButtonFollowers = document.getElementById("openFormButtonFollowers");
                const popupFormFollowers = document.getElementById("popupFormFollowers");
                const closeFormButtonFollowers = document.getElementById("closeFormButtonFollowers");
                openFormButtonFollowers.addEventListener("click", () => {
                    popupFormFollowers.style.display = "flex";
                });
                closeFormButtonFollowers.addEventListener("click", () => {
                    popupFormFollowers.style.display = "none";
                });
                window.addEventListener("click", (event) => {
                    if (event.target == popupFormFollowers) {
                        popupFormFollowers.style.display = "none";
                    }
                });

                const openFormButtonFollowing = document.getElementById("openFormButtonFollowing");
                const popupFormFollowing = document.getElementById("popupFormFollowing");
                const closeFormButtonFollowing = document.getElementById("closeFormButtonFollowing");
                openFormButtonFollowing.addEventListener("click", () => {
                    popupFormFollowing.style.display = "flex";
                });
                closeFormButtonFollowing.addEventListener("click", () => {
                    popupFormFollowing.style.display = "none";
                });
                window.addEventListener("click", (event) => {
                    if (event.target == popupFormFollowing) {
                        popupFormFollowing.style.display = "none";
                    }
                });

                try {
                    // get profile info
                    const responseProfileInfo = await fetch(`/prod/db?accountID=${accountID}`, {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json"
                        }
                    });
                    if(!responseProfileInfo.ok) {
                        throw new Error(`${responseProfileInfo.status}: ${responseProfileInfo.statusText}`);
                    }
                    const dataResponseProfileInfo = await responseProfileInfo.json();

                    // get followers info
                    const responseGetFollowers = await fetch(`/prod/followers?accountID=${accountID}`, {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json"
                        }
                    });
                    if(!responseGetFollowers.ok) {
                        throw new Error(`${responseProfileInfo.status}: ${responseProfileInfo.statusText}`);
                    }
                    const dataResponseGetFollowers = await responseGetFollowers.json();

                    // get all posts
                    const responseGetAllPosts = await fetch("/prod/postDB", {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json"
                        }
                    });
                    if(!responseGetAllPosts.ok) {
                        throw new Error(`${responseGetAllPosts.status}: ${responseGetAllPosts.statusText}`);
                    }
                    const dataGetAllPosts = await responseGetAllPosts.json();

                    // set profile info
                    const profileInfo = document.getElementById("profileInfo");

                    const profileDiv = document.createElement("div");

                    const currentFullName = dataResponseProfileInfo["firstName"] + " " + dataResponseProfileInfo["lastName"]
                    
                    const pName = document.createElement("p");
                    pName.innerHTML = currentFullName;
                    profileDiv.appendChild(pName);

                    const pBirthDate = document.createElement("p");
                    pBirthDate.innerText = dataResponseProfileInfo["birthDate"];
                    profileDiv.appendChild(pBirthDate);

                    const pGender = document.createElement("p");
                    pGender.innerHTML = dataResponseProfileInfo["gender"];
                    profileDiv.appendChild(pGender);

                    profileInfo.appendChild(profileDiv);

                    // set following info
                    const ulFollowers = document.getElementById("followersList");
                    for(let i = 0; i < dataResponseGetFollowers["followers"].length; ++i) {
                        const liFollowers = document.createElement("li");

                        const getUserInfo = await fetch(`/prod/db?accountID=${dataResponseGetFollowers["followers"][i]}`, {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json"
                            }
                        });
                        if(!getUserInfo.ok) {
                            throw new Error(`${responseProfileInfo.status}: ${responseProfileInfo.statusText}`);
                        }
                        const userInfo = await getUserInfo.json();

                        liFollowers.innerHTML = userInfo["firstName"] + " " + userInfo["lastName"];
                        ulFollowers.appendChild(liFollowers);
                    }

                    const ulFollowing = document.getElementById("followingList");
                    for(let i = 0; i < dataResponseGetFollowers["following"].length; ++i) {
                        const liFollowing = document.createElement("li");

                        const getUserInfo = await fetch(`/prod/db?accountID=${dataResponseGetFollowers["following"][i]}`, {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json"
                            }
                        });
                        if(!getUserInfo.ok) {
                            throw new Error(`${responseProfileInfo.status}: ${responseProfileInfo.statusText}`);
                        }
                        const userInfo = await getUserInfo.json();


                        liFollowing.innerHTML = userInfo["firstName"] + " " +userInfo["lastName"];
                        ulFollowing.appendChild(liFollowing);
                    }

                    // set my posts
                    const postsFeed = document.getElementById("postsFeed");
                    for(let i = 0; i < dataGetAllPosts.length; ++i) {
                        if(dataGetAllPosts[i].accountID != accountID) {
                            continue;
                        }

                        const div = document.createElement("div");
                        const hr = document.createElement("hr");

                        const p_id = document.createElement("p");
                        p_id.innerHTML = currentFullName;
                        div.appendChild(p_id);

                        if(dataGetAllPosts[i].postText) {
                            const p_text = document.createElement("p");
                            p_text.innerHTML = dataGetAllPosts[i].postText;
                            div.appendChild(p_text);
                        }
                        if(dataGetAllPosts[i].postPicture) {
                            const post_image = document.createElement("img");
                            post_image.src = dataGetAllPosts[i].postPicture;
                            post_image.style.width = "30%";
                            post_image.style.height = "30%";
                            div.appendChild(post_image);

                            const p_tags = document.createElement("p");
                            p_tags.innerHTML = dataGetAllPosts[i].pictureTags;
                            div.appendChild(p_tags);
                        }
                        const p_time = document.createElement("p");
                        p_time.innerHTML = await formatEpochToUTCString(dataGetAllPosts[i].postTime);
                        div.appendChild(p_time);

                        postsFeed.appendChild(div);
                        postsFeed.appendChild(hr)
                    }

                    const followBtn = document.getElementById("followBtn");
                    if(accountID !== storageAccountID) {
                        try {
                            if(dataResponseGetFollowers["followers"].includes(storageAccountID)) {
                                followBtn.value = "unfollow";
                                followBtn.style.display = "inline";
                                followBtn.onclick = async () => {
                                    const responseFollow = await fetch("/prod/followers", {
                                        method: "PUT",
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                        body: JSON.stringify({ srcAccountID: storageAccountID, dstAccountID: accountID })
                                    });
                                    if(!responseFollow.ok) {
                                        throw new Error(`${responseFollow.status}: ${responseFollow.statusText}`);
                                    } 
                                    alert(`Successfully unfollowed: ${currentFullName}!`);
                                    window.location.reload();
                                };
                            } else {
                                followBtn.value = "follow";
                                followBtn.style.display = "inline";
                                followBtn.onclick = async () => {
                                    const responseFollow = await fetch("/prod/followers", {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                        body: JSON.stringify({ srcAccountID: storageAccountID, dstAccountID: accountID })
                                    });
                                    if(!responseFollow.ok) {
                                        throw new Error(`${responseFollow.status}: ${responseFollow.statusText}`);
                                    } 
                                    alert(`Now following: ${currentFullName}!`);
                                    window.location.reload();
                                }
                            }
                        } catch(error) {
                            console.error(error);
                            alert(error);
                        }
                    }

                    profileInfo.style.display = "block";
                    //ulFollowers.style.display = "block";
                    //ulFollowing.style.display = "block";
                    postsFeed.style.display = "block";
                    
                } catch(error) {
                    console.error(error);
                    alert(error);
                }
            });
        </script>
    </body>
</html>
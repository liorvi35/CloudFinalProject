<!DOCTYPE html>
<html lang="en">
    <head>
        <title>LinkUp - Profile</title>
    </head>
    <style>
        .popup-form {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }
        .form-container {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
        }
    </style>
    <body>
        <h1>My Profile!</h1>
        <input type="button" onclick="window.location.href='/prod/update'" value="Update Profile"/>
        <input type="button" onclick="" value="" id="followBtn" style="display: none;"/>
        <h2>Profile Information</h2>
        <div id="profileInfo" style="display: none;"></div>
        <hr/>
        <input type="button" id="openFormButtonFollowers" value="Followers"/>
        <div id="popupFormFollowers" class="popup-form">
            <div class="form-container">
                <span id="closeFormButtonFollowers" style="cursor: pointer;">&times;</span>
                <h2>Followers</h2>
                <ul id="followersList"></ul>
            </div>
        </div>
        <input type="button" id="openFormButtonFollowing" value="Following"/>
        <div id="popupFormFollowing" class="popup-form">
            <div class="form-container">
                <span id="closeFormButtonFollowing" style="cursor: pointer;">&times;</span>
                <h2>Following</h2>
                <ul id="followingList"></ul>
            </div>
        </div>
        <hr/>
        <h2>My Posts</h2>
        <div id="postsFeed" style="display: none;"></div>
        <script>
            async function formatEpochToUTCString(epochTime) {
                const date = new Date(epochTime * 1000);
                                
                const day = String(date.getUTCDate()).padStart(2, '0');
                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                const year = date.getUTCFullYear();
                
                const hours = String(date.getUTCHours()).padStart(2, '0');
                const minutes = String(date.getUTCMinutes()).padStart(2, '0');
                const seconds = String(date.getUTCSeconds()).padStart(2, '0');
                
                return `${day}/${month}/${year}, ${hours}:${minutes}:${seconds}`;
            }

            document.addEventListener("DOMContentLoaded", async () => {
                const queryString = window.location.search;
                const urlParams = new URLSearchParams(queryString);
                const accountID = urlParams.get("accountID");

                const storageAccountID = localStorage.getItem("accountID");


                const openFormButtonFollowers = document.getElementById("openFormButtonFollowers");
                const popupFormFollowers = document.getElementById("popupFormFollowers");
                const closeFormButtonFollowers = document.getElementById("closeFormButtonFollowers");
                openFormButtonFollowers.addEventListener("click", () => {
                    popupFormFollowers.style.display = "flex";
                });
                closeFormButtonFollowers.addEventListener("click", () => {
                    popupFormFollowers.style.display = "none";
                });
                window.addEventListener("click", (event) => {
                    if (event.target == popupFormFollowers) {
                        popupFormFollowers.style.display = "none";
                    }
                });

                const openFormButtonFollowing = document.getElementById("openFormButtonFollowing");
                const popupFormFollowing = document.getElementById("popupFormFollowing");
                const closeFormButtonFollowing = document.getElementById("closeFormButtonFollowing");
                openFormButtonFollowing.addEventListener("click", () => {
                    popupFormFollowing.style.display = "flex";
                });
                closeFormButtonFollowing.addEventListener("click", () => {
                    popupFormFollowing.style.display = "none";
                });
                window.addEventListener("click", (event) => {
                    if (event.target == popupFormFollowing) {
                        popupFormFollowing.style.display = "none";
                    }
                });

                try {
                    // get profile info
                    const responseProfileInfo = await fetch(`/prod/db?accountID=${accountID}`, {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json"
                        }
                    });
                    if(!responseProfileInfo.ok) {
                        throw new Error(`${responseProfileInfo.status}: ${responseProfileInfo.statusText}`);
                    }
                    const dataResponseProfileInfo = await responseProfileInfo.json();

                    // get followers info
                    const responseGetFollowers = await fetch(`/prod/followers?accountID=${accountID}`, {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json"
                        }
                    });
                    if(!responseGetFollowers.ok) {
                        throw new Error(`${responseProfileInfo.status}: ${responseProfileInfo.statusText}`);
                    }
                    const dataResponseGetFollowers = await responseGetFollowers.json();

                    // get all posts
                    const responseGetAllPosts = await fetch("/prod/postDB", {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json"
                        }
                    });
                    if(!responseGetAllPosts.ok) {
                        throw new Error(`${responseGetAllPosts.status}: ${responseGetAllPosts.statusText}`);
                    }
                    const dataGetAllPosts = await responseGetAllPosts.json();

                    // set profile info
                    const profileInfo = document.getElementById("profileInfo");

                    const profileDiv = document.createElement("div");

                    const currentFullName = dataResponseProfileInfo["firstName"] + " " + dataResponseProfileInfo["lastName"]
                    
                    const pName = document.createElement("p");
                    pName.innerHTML = currentFullName;
                    profileDiv.appendChild(pName);

                    const pBirthDate = document.createElement("p");
                    pBirthDate.innerText = dataResponseProfileInfo["birthDate"];
                    profileDiv.appendChild(pBirthDate);

                    const pGender = document.createElement("p");
                    pGender.innerHTML = dataResponseProfileInfo["gender"];
                    profileDiv.appendChild(pGender);

                    profileInfo.appendChild(profileDiv);

                    // set following info
                    const ulFollowers = document.getElementById("followersList");
                    for(let i = 0; i < dataResponseGetFollowers["followers"].length; ++i) {
                        const liFollowers = document.createElement("li");

                        const getUserInfo = await fetch(`/prod/db?accountID=${dataResponseGetFollowers["followers"][i]}`, {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json"
                            }
                        });
                        if(!getUserInfo.ok) {
                            throw new Error(`${responseProfileInfo.status}: ${responseProfileInfo.statusText}`);
                        }
                        const userInfo = await getUserInfo.json();

                        liFollowers.innerHTML = userInfo["firstName"] + " " + userInfo["lastName"];
                        ulFollowers.appendChild(liFollowers);
                    }

                    const ulFollowing = document.getElementById("followingList");
                    for(let i = 0; i < dataResponseGetFollowers["following"].length; ++i) {
                        const liFollowing = document.createElement("li");

                        const getUserInfo = await fetch(`/prod/db?accountID=${dataResponseGetFollowers["following"][i]}`, {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json"
                            }
                        });
                        if(!getUserInfo.ok) {
                            throw new Error(`${responseProfileInfo.status}: ${responseProfileInfo.statusText}`);
                        }
                        const userInfo = await getUserInfo.json();


                        liFollowing.innerHTML = userInfo["firstName"] + " " +userInfo["lastName"];
                        ulFollowing.appendChild(liFollowing);
                    }

                    // set my posts
                    const postsFeed = document.getElementById("postsFeed");
                    for(let i = 0; i < dataGetAllPosts.length; ++i) {
                        if(dataGetAllPosts[i].accountID !== accountID) {
                            continue;
                        }

                        const getProfileByID = await fetch(`/prod/db?accountID=${dataGetAllPosts[i].accountID}`, {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json"
                            }
                        });

                        const dataGetProfileByID = await getProfileByID.json();

                        const div = document.createElement("div");
                        const hr = document.createElement("hr");

                        const p_id = document.createElement("p");
                        const aLinkToProfile = document.createElement("a");
                        aLinkToProfile.href = `/prod/profile?accountID=${dataGetAllPosts[i].accountID}`;
                        aLinkToProfile.appendChild(p_id);

                        p_id.innerHTML = dataGetProfileByID["firstName"] + " " + dataGetProfileByID["lastName"];
                        div.appendChild(aLinkToProfile);

                        if(dataGetAllPosts[i].postText) {
                            const p_text = document.createElement("p");
                            p_text.innerHTML = dataGetAllPosts[i].postText;
                            div.appendChild(p_text);
                        }
                        if(dataGetAllPosts[i].postPicture) {
                            const post_image = document.createElement("img");
                            post_image.src = dataGetAllPosts[i].postPicture;
                            post_image.style.width = "30%";
                            post_image.style.height = "30%";
                            div.appendChild(post_image);

                            const p_tags = document.createElement("p");
                            p_tags.innerHTML = dataGetAllPosts[i].pictureTags;
                            div.appendChild(p_tags);
                        }
                        const p_time = document.createElement("p");
                        p_time.innerHTML = await formatEpochToUTCString(dataGetAllPosts[i].postTime);
                        div.appendChild(p_time);

                        const likes = dataGetAllPosts[i].likes.length;

                        let comments = 0;
                        for (let j = 0; j < dataGetAllPosts.length; ++j) {
                            let commentsList = dataGetAllPosts[j].comments;
                            for (let k = 0; k < commentsList.length; ++k) {
                                let commentObject = commentsList[k];
                                for (let uuid in commentObject) {
                                    comments += Object.keys(commentObject[uuid]).length;
                                }
                            }
                        }

                        const shares = 0;

                        const pLikes = document.createElement("p");
                        pLikes.innerHTML = `${likes} Likes, ${comments} Comments, ${shares} Shares`;

                        const likeBtn = document.createElement("input");
                        likeBtn.type = "button";
                        likeBtn.value = "Like";

                        const like = async () => {
                            const responseSetLike = await fetch("/prod/postDB", {
                                method: "PUT",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify({
                                    isLike: true,
                                    postAccountID: dataGetAllPosts[i].accountID,
                                    postTime: dataGetAllPosts[i].postTime,
                                    likerAccountID: accountID
                                })
                            });
                            if(!responseSetLike.ok) {
                                throw new Error(`${responseSetLike.status}: ${responseSetLike.statusText}`);
                            }
                            const dataResponseSetLike = await responseSetLike.json();
                            if(dataResponseSetLike.statusCode !== 200) {
                                throw new Error(`${dataResponseSetLike.statusCode}: ${dataResponseSetLike.body}`);
                            }
                        };

                        const unlike = async () => {
                            const responseSetLike = await fetch("/prod/postDB", {
                                method: "PUT",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify({
                                    isLike: false,
                                    postAccountID: dataGetAllPosts[i].accountID,
                                    postTime: dataGetAllPosts[i].postTime,
                                    likerAccountID: accountID
                                })
                            });
                            if(!responseSetLike.ok) {
                                throw new Error(`${responseSetLike.status}: ${responseSetLike.statusText}`);
                            }
                            const dataResponseSetLike = await responseSetLike.json();
                            if(dataResponseSetLike.statusCode !== 200) {
                                throw new Error(`${dataResponseSetLike.statusCode}: ${dataResponseSetLike.body}`);
                            }
                        };

                        const isLiked = dataGetAllPosts[i].likes.includes(storageAccountID);
                        let currentLike = isLiked ? unlike : like;
                        likeBtn.value = isLiked ? "Unlike" : "Like";

                        likeBtn.addEventListener("click", async () => {
                            likeBtn.value = (currentLike === like) ? "Unlike" : "Like";
                            await currentLike();
                            const [oldLikes, , oldComments, , oldShares] = pLikes.textContent.split(" ");
                            const newLikes = (currentLike === like) ? parseInt(oldLikes) + 1 : parseInt(oldLikes) - 1;
                            pLikes.innerHTML = `${newLikes} Likes, ${oldComments} Comments, ${oldShares} Shares`;
                            currentLike = (currentLike === like) ? unlike : like;
                        });

                        const commentInput = document.createElement("input");
                        commentInput.type = "text";
                        commentInput.placeholder = "Write Your Comment";

                        const commentBtn = document.createElement("input");
                        commentBtn.type = "button";
                        commentBtn.value = "Comment";
                        commentBtn.onclick = async () => {
                            const commentTime = Math.floor(Date.now() / 1000);
                            const commentText = commentInput.value.trim();

                            if(commentText === "") {
                                alert("Comment cannot be empty!");
                                return;
                            }

                            const responseNewComment = await fetch("/prod/postDB", {
                                method: "PUT",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify({
                                    postAccountID: dataGetAllPosts[i].accountID,
                                    postTime: dataGetAllPosts[i].postTime,
                                    likerAccountID: accountID,
                                    commentText,
                                    commentTime
                                })
                            });
                            if(!responseNewComment.ok) {
                                throw new Error(`${responseNewComment.status}: ${responseNewComment.statusText}`);
                            }
                            const dataResponseNewComment = await responseNewComment.json();
                            if(dataResponseNewComment.statusCode !== 200) {
                                throw new Error(`${dataResponseNewComment.statusCode}: ${dataResponseNewComment.body}`);
                            }

                            const oldLikes = pLikes.textContent.split(" ")[0];
                            const oldComments = pLikes.textContent.split(" ")[2];
                            const oldShares = pLikes.textContent.split(" ")[4];
                            pLikes.innerHTML = `${oldLikes} Likes, ${parseInt(oldComments) + 1} Comments, ${oldShares} Shares`;
                            commentInput.value = "";
                        };

                        const deleteBtn = document.createElement("input");
                        deleteBtn.type = "button";
                        deleteBtn.value = "Delete Post";
                        deleteBtn.onclick = async () => {
                            const reponseDeletePost = await fetch ("/prod/postDB", {
                                method: "DELETE",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify({
                                    postAccountID: dataGetAllPosts[i].accountID,
                                    postTime: dataGetAllPosts[i].postTime
                                })
                            });
                            if(!reponseDeletePost.ok) {
                                throw new Error(`${reponseDeletePost.status}: ${reponseDeletePost.statusText}`);
                            }
                            const dataResponsDeletePost = await reponseDeletePost.json();
                            if(dataResponsDeletePost.statusCode !== 200) {
                                throw new Error(`${dataResponsDeletePost.statusCode}: ${dataResponsDeletePost.body}`);
                            }
                            window.location.reload();
                        };

                        div.appendChild(pLikes);
                        div.appendChild(likeBtn);

                        div.appendChild(commentInput);
                        div.appendChild(commentBtn);

                        if(accountID === storageAccountID) {
                            div.appendChild(deleteBtn);
                        }

                        postsFeed.appendChild(div);
                        postsFeed.appendChild(hr)
                    }


                    const followBtn = document.getElementById("followBtn");
                    if(accountID !== storageAccountID) {
                        try {
                            if(dataResponseGetFollowers["followers"].includes(storageAccountID)) {
                                followBtn.value = "unfollow";
                                followBtn.style.display = "inline";
                                followBtn.onclick = async () => {
                                    const responseFollow = await fetch("/prod/followers", {
                                        method: "PUT",
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                        body: JSON.stringify({ srcAccountID: storageAccountID, dstAccountID: accountID })
                                    });
                                    if(!responseFollow.ok) {
                                        throw new Error(`${responseFollow.status}: ${responseFollow.statusText}`);
                                    } 
                                    alert(`Successfully unfollowed: ${currentFullName}!`);
                                    window.location.reload();
                                };
                            } else {
                                followBtn.value = "follow";
                                followBtn.style.display = "inline";
                                followBtn.onclick = async () => {
                                    const responseFollow = await fetch("/prod/followers", {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                        body: JSON.stringify({ srcAccountID: storageAccountID, dstAccountID: accountID })
                                    });
                                    if(!responseFollow.ok) {
                                        throw new Error(`${responseFollow.status}: ${responseFollow.statusText}`);
                                    } 
                                    alert(`Now following: ${currentFullName}!`);
                                    window.location.reload();
                                }
                            }
                        } catch(error) {
                            console.error(error);
                            alert(error);
                        }
                    }

                    profileInfo.style.display = "block";
                    postsFeed.style.display = "block";
                    
                } catch(error) {
                    console.error(error);
                    alert(error);
                }
            });
        </script>
    </body>
</html>
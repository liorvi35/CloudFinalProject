<!DOCTYPE html>
<html lang="en">
    <head>
        <title>LinkUp - Global Feed</title>
        <style>
            .search-container {
                width: 300px;
                position: relative;
            }
    
            #search-bar {
                width: 100%;
                padding: 10px;
                border-radius: 4px;
            }
    
            .results {
                border: 1px solid #ccc;
                border-top: none;
                border-radius: 0 0 4px 4px;
                max-height: 150px;
                overflow-y: auto;
                background-color: white;
                position: absolute;
                width: 100%;
                z-index: 10;
            }
    
            .result-item {
                padding: 8px 10px;
                cursor: pointer;
                text-decoration: none;
                color: black;
                display: block;
            }
    
            .result-item:hover {
                background-color: #f0f0f0;
            }
    
            .no-results {
                padding: 8px 10px;
                color: #777;
            }
        </style>
    </head>
    <body>
        <h1>Global Feed</h1>
        <div class="search-container" id="search-container">
            <input type="text" id="search-bar" placeholder="Search for new friends!">
            <div class="results" id="results"></div>
        </div>    
        <input type="button" onclick="" id="profileBtn" value="My Profile"/>
        <input type="button" onclick="window.location.href='/prod/friendsFeed'" value="Friends Feed"/>
        <h2>Upload Post</h2>
        <form>
            <input type="text" id="postText"/>
            <input type="file" accept=".jpeg, .jpg, .png" id="postPicture"/>
            <input type="button" value="Post!" id="postBtn"/>
        </form>
        <hr/>
        <div id="postsFeed"></div>
        <script>
            async function formatEpochToUTCString(epochTime) {
                const date = new Date(epochTime * 1000);
                                
                const day = String(date.getUTCDate()).padStart(2, '0');
                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                const year = date.getUTCFullYear();
                
                const hours = String(date.getUTCHours()).padStart(2, '0');
                const minutes = String(date.getUTCMinutes()).padStart(2, '0');
                const seconds = String(date.getUTCSeconds()).padStart(2, '0');
                
                return `${day}/${month}/${year}, ${hours}:${minutes}:${seconds}`;
            }


            async function arrayBufferToBase64(buffer) {
                let binary = "";
                const bytes = new Uint8Array(buffer);
                const len = bytes.byteLength;
                for (let i = 0; i < len; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return window.btoa(binary);
            }

            document.addEventListener("DOMContentLoaded", async () => {
                const accountID = localStorage.getItem("accountID");

                const responseAllUsers = await fetch("/prod/db?accountID=ALL", {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json"
                    }
                });

                if (!responseAllUsers.ok) {
                    throw new Error(`${responseAllUsers.status}: ${responseAllUsers.statusText}`);
                }

                const dataResponseAllUsers = await responseAllUsers.json();

                const items = dataResponseAllUsers.map(json => ({
                    name: `${json.firstName.trim()} ${json.lastName}`,
                    accountID: json.accountID
                }));

                const searchBar = document.getElementById("search-bar");
                const resultsContainer = document.getElementById("results");
                const searchContainer = document.getElementById("search-container");

                searchBar.addEventListener("input", () => {
                    const query = searchBar.value.toLowerCase();
                    resultsContainer.innerHTML = "";

                    const filteredItems = items.filter(item => item.name.toLowerCase().includes(query));

                    if (filteredItems.length === 0) {
                        resultsContainer.innerHTML = '<div class="no-results">No results found</div>';
                    } else {
                        filteredItems.forEach(item => {
                            const a = document.createElement("a");
                            a.classList.add("result-item");
                            a.href = `/prod/profile?accountID=${item.accountID}`;
                            a.textContent = item.name;
                            resultsContainer.appendChild(a);
                        });
                    }

                    resultsContainer.style.display = filteredItems.length > 0 ? "block" : "none";
                });

                document.addEventListener("click", (event) => {
                    if (!searchContainer.contains(event.target)) {
                        resultsContainer.style.display = "none";
                    }
                });

                searchContainer.addEventListener("click", (event) => {
                    event.stopPropagation();
                    resultsContainer.style.display = "block";
                });


                document.getElementById("profileBtn").onclick = () => {
                    window.location.href = `/prod/profile?accountID=${accountID}`;
                };

                try {
                    const responseGetAllPosts = await fetch("/prod/postDB", {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json"
                        }
                    });

                    if(!responseGetAllPosts.ok) {
                        throw new Error(`${responseGetAllPosts.status}: ${responseGetAllPosts.statusText}`);
                    }

                    const dataGetAllPosts = await responseGetAllPosts.json();

                    if(dataGetAllPosts.length > 0) {
                        const postsFeed = document.getElementById("postsFeed");
                        for(let i = 0; i < dataGetAllPosts.length; ++i) {
                            const getProfileByID = await fetch(`/prod/db?accountID=${dataGetAllPosts[i].accountID}`, {
                                method: "GET",
                                headers: {
                                    "Content-Type": "application/json"
                                }
                            });

                            const dataGetProfileByID = await getProfileByID.json();

                            const div = document.createElement("div");
                            const hr = document.createElement("hr");

                            const p_id = document.createElement("p");
                            const aLinkToProfile = document.createElement("a");
                            aLinkToProfile.href = `/prod/profile?accountID=${dataGetAllPosts[i].accountID}`;
                            aLinkToProfile.appendChild(p_id);

                            p_id.innerHTML = dataGetProfileByID["firstName"] + " " + dataGetProfileByID["lastName"];
                            div.appendChild(aLinkToProfile);

                            if(dataGetAllPosts[i].postText) {
                                const p_text = document.createElement("p");
                                p_text.innerHTML = dataGetAllPosts[i].postText;
                                div.appendChild(p_text);
                            }
                            if(dataGetAllPosts[i].postPicture) {
                                const post_image = document.createElement("img");
                                post_image.src = dataGetAllPosts[i].postPicture;
                                post_image.style.width = "30%";
                                post_image.style.height = "30%";
                                div.appendChild(post_image);

                                const p_tags = document.createElement("p");
                                p_tags.innerHTML = dataGetAllPosts[i].pictureTags;
                                div.appendChild(p_tags);
                            }
                            const p_time = document.createElement("p");
                            p_time.innerHTML = await formatEpochToUTCString(dataGetAllPosts[i].postTime);
                            div.appendChild(p_time);

                            const likeBtn = document.createElement("input");
                            likeBtn.type = "button";

                            const likes = dataGetAllPosts[i].likes.length;
                            const comments = 0;
                            const shares = 0;

                            const pLikes = document.createElement("p");
                            pLikes.innerHTML = `${likes} Likes, ${comments} Comments, ${shares} Shares`;

                            if(dataGetAllPosts[i].likes.includes(accountID)) {
                                likeBtn.value = "Unlike";
                                likeBtn.onclick = async () => {
                                    const responseSetLike = await fetch("/prod/postDB", {
                                        method: "PUT",
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                        body: JSON.stringify({
                                            isLike: false,
                                            postAccountID: dataGetAllPosts[i].accountID,
                                            postTime: dataGetAllPosts[i].postTime,
                                            likerAccountID: accountID
                                        })
                                    });
                                    if(!responseSetLike.ok) {
                                        throw new Error(`${responseSetLike.status}: ${responseSetLike.statusText}`);
                                    }
                                    const dataResponseSetLike = await responseSetLike.json();
                                    if(dataResponseSetLike.statusCode !== 200) {
                                        throw new Error(`${dataResponseSetLike.statusCode}: ${dataResponseSetLike.body}`);
                                    }
                                };
                            } else {
                                likeBtn.value = "Like";
                                likeBtn.onclick = async () => {
                                    const responseSetLike = await fetch("/prod/postDB", {
                                        method: "PUT",
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                        body: JSON.stringify({
                                            isLike: true,
                                            postAccountID: dataGetAllPosts[i].accountID,
                                            postTime: dataGetAllPosts[i].postTime,
                                            likerAccountID: accountID
                                        })
                                    });
                                    if(!responseSetLike.ok) {
                                        throw new Error(`${responseSetLike.status}: ${responseSetLike.statusText}`);
                                    }
                                    const dataResponseSetLike = await responseSetLike.json();
                                    if(dataResponseSetLike.statusCode !== 200) {
                                        throw new Error(`${dataResponseSetLike.statusCode}: ${dataResponseSetLike.body}`);
                                    }
                                };
                            }

                            const commentInput = document.createElement("input");
                            commentInput.type = "text";
                            commentInput.placeholder = "Write Your Comment";

                            const commentBtn = document.createElement("input");
                            commentBtn.type = "button";
                            commentBtn.value = "Comment";
                            commentBtn.onclick = async () => {
                                const commentTime = Math.floor(Date.now() / 1000);
                                
                            };


                            div.appendChild(pLikes);
                            div.appendChild(likeBtn);

                            div.appendChild(commentInput);
                            div.appendChild(commentBtn);

                            postsFeed.appendChild(div);
                            postsFeed.appendChild(hr)
                        }
                    }
                } catch(error) {
                    console.error(error);
                    alert(error);
                }

                document.getElementById("postBtn").addEventListener("click", async () => {
                    const postTime = Math.floor(Date.now() / 1000);
                    const text = document.getElementById("postText").value;
                    const fileInput = document.getElementById("postPicture");
                    const file = fileInput.files[0];
                    
                    let isText = false, isPicture = false;

                    let postData = {};

                    if(text.trim() !== "") {
                        isText = true;
                    }
                    if(file) {
                        isPicture = true;
                    }
                    if(!(isText || isPicture)) {
                        alert("Cannot upload empty post");
                        return;
                    }

                    if(isPicture) {
                        const reader = new FileReader();
                        reader.onloadend = async () => {
                          const base64File = await arrayBufferToBase64(reader.result);
                          const format = file.type.split("/")[1];

                          let postData = {}
                          if(isText) {
                            postData["postText"] = text.trim();
                          }
                          postData["accountID"] = accountID;
                          postData["format"] = format;
                          postData["postPicture"] = base64File;
                          postData["postTime"] = postTime;

                          try {
                            const responseUploadPost = await fetch("/prod/postDB", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify(postData)
                            });

                            if(!responseUploadPost.ok) {
                                throw new Error(`${responseUploadPost.status}: ${responseUploadPost.statusText}`);
                            }

                            const dataUploadPost = await responseUploadPost.json();

                            if(dataUploadPost.statusCode === 200) {
                                window.location.reload();
                            } else {
                                throw new Error(`${dataUploadPost.statusCode}: ${dataUploadPost.body}`);
                            }
                          } catch(error) {
                            console.error(error);
                            alert(error);
                          }
                        };
                        reader.readAsArrayBuffer(file);
                    } else if(isText && !isPicture) {
                        const postData = { accountID, postTime, postText: text.trim() };

                        try {
                            const responseUploadPost = await fetch("/prod/postDB", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify(postData)
                            });

                            if(!responseUploadPost.ok) {
                                throw new Error(`${responseUploadPost.status}: ${responseUploadPost.statusText}`);
                            }

                            const dataUploadPost = await responseUploadPost.json();

                            if(dataUploadPost.statusCode === 200) {
                                window.location.reload();
                            } else {
                                throw new Error(`${dataUploadPost.statusCode}: ${dataUploadPost.body}`);
                            }
                        } catch(error) {
                            console.error(error);
                            alert(error);
                        }
                    }
                });
            });            
        </script>
    </body>
</html>
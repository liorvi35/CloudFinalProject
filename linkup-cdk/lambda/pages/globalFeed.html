<!DOCTYPE html>
<html lang="en">
    <head>
        <title>LinkUp - Global Feed</title>
    </head>
    <body>
        <h1>Global Feed</h1>
        <input type="button" onclick="window.location.href='/prod/profile'" value="My Profile"/>
        <input type="button" onclick="window.location.href='/prod/friendsFeed'" value="Friends Feed"/>
        <h2>Upload Post</h2>
        <form>
            <input type="text" id="postText"/>
            <input type="file" accept=".jpeg, .jpg, .png" id="postPicture"/>
            <input type="button" value="Post!" id="postBtn"/>
        </form>
        <hr/>
        <div id="postsFeed"></div>
        <script>
            async function formatEpochToUTCString(epochTime) {
                const date = new Date(epochTime * 1000);
                                
                const day = String(date.getUTCDate()).padStart(2, '0');
                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                const year = date.getUTCFullYear();
                
                const hours = String(date.getUTCHours()).padStart(2, '0');
                const minutes = String(date.getUTCMinutes()).padStart(2, '0');
                const seconds = String(date.getUTCSeconds()).padStart(2, '0');
                
                return `${day}/${month}/${year}, ${hours}:${minutes}:${seconds}`;
            }


            async function arrayBufferToBase64(buffer) {
                let binary = "";
                const bytes = new Uint8Array(buffer);
                const len = bytes.byteLength;
                for (let i = 0; i < len; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return window.btoa(binary);
            }

            document.addEventListener("DOMContentLoaded", async () => {
                const accountID = localStorage.getItem("accountID");

                try {
                    const responseGetAllPosts = await fetch("/prod/postDB", {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json"
                        }
                    });

                    if(!responseGetAllPosts.ok) {
                        throw new Error(`${responseGetAllPosts.status}: ${responseGetAllPosts.statusText}`);
                    }

                    const dataGetAllPosts = await responseGetAllPosts.json();

                    if(dataGetAllPosts.length > 0) {
                        const postsFeed = document.getElementById("postsFeed");
                        for(let i = 0; i < dataGetAllPosts.length; ++i) {
                            const getProfileByID = await fetch(`/prod/db?accountID=${dataGetAllPosts[i].accountID}`, {
                                method: "GET",
                                headers: {
                                    "Content-Type": "application/json"
                                }
                            });

                            const dataGetProfileByID = await getProfileByID.json();

                            const div = document.createElement("div");
                            const hr = document.createElement("hr");

                            const p_id = document.createElement("p");
                            p_id.innerHTML = dataGetProfileByID["firstName"] + " " + dataGetProfileByID["lastName"];
                            div.appendChild(p_id);

                            if(dataGetAllPosts[i].postText) {
                                const p_text = document.createElement("p");
                                p_text.innerHTML = dataGetAllPosts[i].postText;
                                div.appendChild(p_text);
                            }
                            if(dataGetAllPosts[i].postPicture) {
                                const post_image = document.createElement("img");
                                post_image.src = dataGetAllPosts[i].postPicture;
                                post_image.style.width = "30%";
                                post_image.style.height = "30%";
                                div.appendChild(post_image);

                                const p_tags = document.createElement("p");
                                p_tags.innerHTML = dataGetAllPosts[i].pictureTags;
                                div.appendChild(p_tags);
                            }
                            const p_time = document.createElement("p");
                            p_time.innerHTML = await formatEpochToUTCString(dataGetAllPosts[i].postTime);
                            div.appendChild(p_time);

                            postsFeed.appendChild(div);
                            postsFeed.appendChild(hr)
                        }
                    }
                } catch(error) {
                    console.error(error);
                    alert(error);
                }

                document.getElementById("postBtn").addEventListener("click", async () => {
                    const postTime = Math.floor(Date.now() / 1000);
                    const text = document.getElementById("postText").value;
                    const fileInput = document.getElementById("postPicture");
                    const file = fileInput.files[0];
                    
                    let isText = false, isPicture = false;

                    let postData = {};

                    if(text.trim() !== "") {
                        isText = true;
                    }
                    if(file) {
                        isPicture = true;
                    }
                    if(!(isText || isPicture)) {
                        alert("Cannot upload empty post");
                        return;
                    }

                    if(isPicture) {
                        const reader = new FileReader();
                        reader.onloadend = async () => {
                          const base64File = await arrayBufferToBase64(reader.result);
                          const format = file.type.split("/")[1];

                          let postData = {}
                          if(isText) {
                            postData["postText"] = text.trim();
                          }
                          postData["accountID"] = accountID;
                          postData["format"] = format;
                          postData["postPicture"] = base64File;
                          postData["postTime"] = postTime;

                          try {
                            const responseUploadPost = await fetch("/prod/postDB", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify(postData)
                            });

                            if(!responseUploadPost.ok) {
                                throw new Error(`${responseUploadPost.status}: ${responseUploadPost.statusText}`);
                            }

                            const dataUploadPost = await responseUploadPost.json();

                            if(dataUploadPost.statusCode === 200) {
                                window.location.reload();
                            } else {
                                throw new Error(`${dataUploadPost.statusCode}: ${dataUploadPost.body}`);
                            }
                          } catch(error) {
                            console.error(error);
                            alert(error);
                          }
                        };
                        reader.readAsArrayBuffer(file);
                    } else if(isText && !isPicture) {
                        const postData = { accountID, postTime, postText: text.trim() };

                        try {
                            const responseUploadPost = await fetch("/prod/postDB", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify(postData)
                            });

                            if(!responseUploadPost.ok) {
                                throw new Error(`${responseUploadPost.status}: ${responseUploadPost.statusText}`);
                            }

                            const dataUploadPost = await responseUploadPost.json();

                            if(dataUploadPost.statusCode === 200) {
                                window.location.reload();
                            } else {
                                throw new Error(`${dataUploadPost.statusCode}: ${dataUploadPost.body}`);
                            }
                        } catch(error) {
                            console.error(error);
                            alert(error);
                        }
                    }
                });
            });
        </script>
    </body>
</html>
<!DOCTYPE html>
<html lang="en">
    <head>
        <title>LinkUp - Friends Feed</title>
    </head>
    <body>
        <h1>Friends Feed</h1>
        <input type="button" onclick="" id="profileBtn" value="My Profile"/>
        <input type="button" onclick="window.location.href='/prod/globalFeed'" value="Global Feed"/>
        <div id="postsFeed"></div>
        <script>
            async function formatEpochToUTCString(epochTime) {
                const date = new Date(epochTime * 1000);
                                
                const day = String(date.getUTCDate()).padStart(2, '0');
                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                const year = date.getUTCFullYear();
                
                const hours = String(date.getUTCHours()).padStart(2, '0');
                const minutes = String(date.getUTCMinutes()).padStart(2, '0');
                const seconds = String(date.getUTCSeconds()).padStart(2, '0');
                
                return `${day}/${month}/${year}, ${hours}:${minutes}:${seconds}`;
            }

            document.addEventListener("DOMContentLoaded", async () => {
                const accountID = localStorage.getItem("accountID");

                document.getElementById("profileBtn").onclick = () => {
                    window.location.href = `/prod/profile?accountID=${accountID}`;
                };
                
                try {
                    const responseFollowing = await fetch(`/prod/followers?accountID=${accountID}`, {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json"
                        }
                    });

                    if(!responseFollowing.ok) {
                        throw new Error(`${responseFollowing.status}: ${responseFollowing.statusText}`);
                    }

                    const dataResponseFollowing = await responseFollowing.json();

                    const responseGetAllPosts = await fetch("/prod/postDB", {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json"
                        }
                    });

                    if(!responseGetAllPosts.ok) {
                        throw new Error(`${responseGetAllPosts.status}: ${responseGetAllPosts.statusText}`);
                    }

                    const dataGetAllPosts = await responseGetAllPosts.json();

                    if(dataGetAllPosts.length > 0) {
                        const postsFeed = document.getElementById("postsFeed");
                        for(let i = 0; i < dataGetAllPosts.length; ++i) {
                            const getProfileByID = await fetch(`/prod/db?accountID=${dataGetAllPosts[i].accountID}`, {
                                method: "GET",
                                headers: {
                                    "Content-Type": "application/json"
                                }
                            });

                            const dataGetProfileByID = await getProfileByID.json();

                            const div = document.createElement("div");
                            const hr = document.createElement("hr");

                            const p_id = document.createElement("p");
                            const aLinkToProfile = document.createElement("a");
                            aLinkToProfile.href = `/prod/profile?accountID=${dataGetAllPosts[i].accountID}`;
                            aLinkToProfile.appendChild(p_id);

                            p_id.innerHTML = dataGetProfileByID["firstName"] + " " + dataGetProfileByID["lastName"];
                            div.appendChild(aLinkToProfile);

                            if(dataGetAllPosts[i].postText) {
                                const p_text = document.createElement("p");
                                p_text.innerHTML = dataGetAllPosts[i].postText;
                                div.appendChild(p_text);
                            }
                            if(dataGetAllPosts[i].postPicture) {
                                const post_image = document.createElement("img");
                                post_image.src = dataGetAllPosts[i].postPicture;
                                post_image.style.width = "30%";
                                post_image.style.height = "30%";
                                div.appendChild(post_image);

                                const p_tags = document.createElement("p");
                                p_tags.innerHTML = dataGetAllPosts[i].pictureTags;
                                div.appendChild(p_tags);
                            }
                            const p_time = document.createElement("p");
                            p_time.innerHTML = await formatEpochToUTCString(dataGetAllPosts[i].postTime);
                            div.appendChild(p_time);

                            const likes = dataGetAllPosts[i].likes.length;

                            let comments = 0;
                            for (let j = 0; j < dataGetAllPosts.length; ++j) {
                                let commentsList = dataGetAllPosts[j].comments;
                                for (let k = 0; k < commentsList.length; ++k) {
                                    let commentObject = commentsList[k];
                                    for (let uuid in commentObject) {
                                        comments += Object.keys(commentObject[uuid]).length;
                                    }
                                }
                            }

                            const shares = 0;

                            const pLikes = document.createElement("p");
                            pLikes.innerHTML = `${likes} Likes, ${comments} Comments, ${shares} Shares`;

                            const likeBtn = document.createElement("input");
                            likeBtn.type = "button";
                            likeBtn.value = "Like";

                            const like = async () => {
                                const responseSetLike = await fetch("/prod/postDB", {
                                    method: "PUT",
                                    headers: {
                                        "Content-Type": "application/json"
                                    },
                                    body: JSON.stringify({
                                        isLike: true,
                                        postAccountID: dataGetAllPosts[i].accountID,
                                        postTime: dataGetAllPosts[i].postTime,
                                        likerAccountID: accountID
                                    })
                                });
                                if(!responseSetLike.ok) {
                                    throw new Error(`${responseSetLike.status}: ${responseSetLike.statusText}`);
                                }
                                const dataResponseSetLike = await responseSetLike.json();
                                if(dataResponseSetLike.statusCode !== 200) {
                                    throw new Error(`${dataResponseSetLike.statusCode}: ${dataResponseSetLike.body}`);
                                }
                            };

                            const unlike = async () => {
                                const responseSetLike = await fetch("/prod/postDB", {
                                    method: "PUT",
                                    headers: {
                                        "Content-Type": "application/json"
                                    },
                                    body: JSON.stringify({
                                        isLike: false,
                                        postAccountID: dataGetAllPosts[i].accountID,
                                        postTime: dataGetAllPosts[i].postTime,
                                        likerAccountID: accountID
                                    })
                                });
                                if(!responseSetLike.ok) {
                                    throw new Error(`${responseSetLike.status}: ${responseSetLike.statusText}`);
                                }
                                const dataResponseSetLike = await responseSetLike.json();
                                if(dataResponseSetLike.statusCode !== 200) {
                                    throw new Error(`${dataResponseSetLike.statusCode}: ${dataResponseSetLike.body}`);
                                }
                            };

                            const isLiked = dataGetAllPosts[i].likes.includes(accountID);
                            let currentLike = isLiked ? unlike : like;
                            likeBtn.value = isLiked ? "Unlike" : "Like";

                            likeBtn.addEventListener("click", async () => {
                                likeBtn.value = (currentLike === like) ? "Unlike" : "Like";
                                await currentLike();
                                const [oldLikes, , oldComments, , oldShares] = pLikes.textContent.split(" ");
                                const newLikes = (currentLike === like) ? parseInt(oldLikes) + 1 : parseInt(oldLikes) - 1;
                                pLikes.innerHTML = `${newLikes} Likes, ${oldComments} Comments, ${oldShares} Shares`;
                                currentLike = (currentLike === like) ? unlike : like;
                            });

                            const commentInput = document.createElement("input");
                            commentInput.type = "text";
                            commentInput.placeholder = "Write Your Comment";

                            const commentBtn = document.createElement("input");
                            commentBtn.type = "button";
                            commentBtn.value = "Comment";
                            commentBtn.onclick = async () => {
                                const commentTime = Math.floor(Date.now() / 1000);
                                const commentText = commentInput.value.trim();

                                if(commentText === "") {
                                    alert("Comment cannot be empty!");
                                    return;
                                }

                                const responseNewComment = await fetch("/prod/postDB", {
                                    method: "PUT",
                                    headers: {
                                        "Content-Type": "application/json"
                                    },
                                    body: JSON.stringify({
                                        postAccountID: dataGetAllPosts[i].accountID,
                                        postTime: dataGetAllPosts[i].postTime,
                                        likerAccountID: accountID,
                                        commentText,
                                        commentTime
                                    })
                                });
                                if(!responseNewComment.ok) {
                                    throw new Error(`${responseNewComment.status}: ${responseNewComment.statusText}`);
                                }
                                const dataResponseNewComment = await responseNewComment.json();
                                if(dataResponseNewComment.statusCode !== 200) {
                                    throw new Error(`${dataResponseNewComment.statusCode}: ${dataResponseNewComment.body}`);
                                }

                                const oldLikes = pLikes.textContent.split(" ")[0];
                                const oldComments = pLikes.textContent.split(" ")[2];
                                const oldShares = pLikes.textContent.split(" ")[4];
                                pLikes.innerHTML = `${oldLikes} Likes, ${parseInt(oldComments) + 1} Comments, ${oldShares} Shares`;
                                commentInput.value = "";
                            };

                            div.appendChild(pLikes);
                            div.appendChild(likeBtn);

                            div.appendChild(commentInput);
                            div.appendChild(commentBtn);

                            postsFeed.appendChild(div);
                            postsFeed.appendChild(hr)
                        }
                    }
                } catch(error) {
                    console.error(error);
                    alert(error);
                }
            });
        </script>
    </body>
</html>